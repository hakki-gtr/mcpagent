name: Unit Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Cache npm dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('src/typescript-runtime/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-
          ${{ runner.os }}-
    
    - name: Test mcpagent (Unit Tests Only)
      run: |
        cd src/mcpagent
        echo "Running mcpagent unit tests..."
        mvn test -Dtest="AgentServiceTest,TelemetryServiceTracingTest,TelemetryServiceMetricsTest,LogContextTest,TelemetryConfigTest,KnowledgeBaseServiceImplTest,FileKnowledgeBasePersistenceTest,OrchestratorImplTest,AgentServiceConfigTest"
    
    - name: Test acme-analytics-server
      run: |
        cd src/acme-analytics-server/server
        echo "Running acme-analytics-server tests..."
        mvn test
    
    - name: Test typescript-runtime
      run: |
        cd src/typescript-runtime
        echo "Installing dependencies..."
        npm install --legacy-peer-deps
        echo "Running typescript-runtime tests..."
        npm test
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-results
        path: |
          src/mcpagent/target/surefire-reports/
          src/acme-analytics-server/server/target/surefire-reports/
          src/typescript-runtime/coverage/
        retention-days: 7
